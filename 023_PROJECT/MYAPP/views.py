from django.shortcuts import render,redirect,HttpResponse
from django.contrib.auth.models import User
from django.contrib.auth import authenticate,login,logout
from django.contrib.auth.decorators import login_required
from MYAPP.models import *
from django.http import JsonResponse
import razorpay
from datetime import datetime

# Create your views here.

def index(request):
    categories = Category.objects.all()
    products = Product.objects.all()
    try:
        cid = request.GET['cid']
    # print(cid)
        if cid!=0:  
            products = Product.objects.filter(category_id=cid)
        else:
            products = Product.objects.all()
        return render(request,"index.html",{"categories":categories,"products":products})
    except Exception as  e:
        return render(request,"index.html",{"categories":categories,"products":products})
    return render(request,'index.html')
    

# def allcategories(request):
#     categories = Category.objects.all()
#     return JsonResponse({"data":list(categories.values())})


def blog_details(request):
    return render(request,'blog-details.html')

def blog(request):
    return render(request,'blog.html')

@login_required(login_url="login-register")
def checkout(request):
    return render(request,'checkout.html')

def contact(request):
    return render(request,'contact.html')

def main(request):
    return render(request,'main.html')

def shope_details(request):
    return render(request,'shop-details.html')

def shop_grid(request):
    return render(request,'shop-grid.html')

@login_required(login_url="login-register")
def shopping_cart(request):
    cartdata = Cart.objects.filter(user=request.user)

    sum = 0 
    for i in cartdata:
        sum+=i.subtotal()

    return render(request,"shoping-cart.html",{"cdata":cartdata,"total":int(sum)})


def register(request):
    if request.method == "POST":
        username = request.POST.get("username")
        email = request.POST.get("email")
        password = request.POST.get("password")
        user = User.objects.filter(username=username).exists()
        if user:
            return render(request,'login.html',{"rerr":"Username Already Exists"})
        u = User(username=username,email=email)
        u.set_password(password)
        u.save()
        return render(request,'login.html',{"msg":"User Registered Successfully"})
    return render(request,'login.html')

def user_login(request):
    if request.method == "POST":
        username = request.POST.get("username")
        password = request.POST.get("password")
        user = authenticate(username=username,password=password)
        if user:
            login(request,user)
            return render(request,"index.html")
        else:
            return render(request,"login.html",{"err":"Invalid Username or Password"})
            
    return render(request,"login.html")

def user_logout(request):
    logout(request)
    return redirect("index")


def add_to_cart(request):

    if not request.user.is_anonymous:
        pid =request.GET['pid']
        product = Product.objects.get(id=pid)

        cdata = Cart.objects.filter(product=product,user=request.user)
        if len(cdata)>0:
            cdata[0].qty = cdata[0].qty+1
            cdata[0].save()
            return HttpResponse("Product added in to cart !!!")
        else:
            Cart.objects.create(product=product,user=request.user,qty=1)
            return HttpResponse("Product added in to cart !!!")
    else:
        return HttpResponse(request.user)
    

def deletecart(request):
    cid = request.GET['cid']
    cart = Cart.objects.get(pk=cid)
    cart.delete()
    return HttpResponse("cart deleted")

    
def changeqty(request):
    cartid = request.GET['cartid']
    qty = request.GET['qty']

    cart = Cart.objects.get(pk=cartid)
    if int(qty)<=0:
        cart.delete()
    else:
        cart.qty =qty
        cart.save()
    return HttpResponse("cart updates!!!...")



def payment(request):
    orders = UserOrder.objects.all()
    rid = len(orders)+1
    amt = int(request.GET['amt'])
    client = razorpay.Client(auth=("rzp_test_RZYCurZ7FP1mAI", "mTOQVly7LNDc33xPvWSqG9hw"))

    data = { "amount": amt*100, "currency": "INR", "receipt": "order_rcptid_{rid}" }
    payment = client.order.create(data=data) # Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
    return JsonResponse(payment)

def makeorder(request):
    rid = request.GET['rid']
    payid = request.GET['payid']
    oid = request.GET['oid']
    total = request.GET['total']
    
    order = UserOrder.objects.create(
        user=request.user,
        paymentid =payid,
        total = total,
        receiptid = rid,
        orderid = oid,
        date = datetime.now()
    )

    cardata = Cart.objects.filter(user = request.user)
    for cart in cardata:
        OrderDetails.objects.create(order=order,product=cart.product,qty=cart.qty,price=cart.product.price)
        cart.delete()
     
    # print(rid,payid,oid)
    return HttpResponse("order sucessfully placed!!!")
